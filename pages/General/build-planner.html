<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Build Planner &mdash; Project Rogue Codex</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <base href="../../" />
    <link rel="icon" type="image/x-icon" href="images/project-rogue-favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="images/project-rogue-favicon-32.png" />
    <link rel="icon" type="image/png" sizes="64x64" href="images/project-rogue-favicon-64.png" />
    <link rel="icon" type="image/png" sizes="180x180" href="images/project-rogue-favicon-180.png" />
    <link rel="icon" type="image/png" sizes="512x512" href="images/project-rogue-favicon-512.png" />
    <link rel="stylesheet" href="css/styles.css" />
    <script src="js/nav-loader.js" defer></script>
    <style>
      .planner-section {
        margin-top: 1rem;
      }

      .planner-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 1rem;
        align-items: stretch;
      }

      .planner-col {
        display: flex;
        flex-direction: column;
        gap: 0.9rem;
        min-height: 440px;
        padding: 0.25rem;
      }

      .planner-col--stacked {
        justify-content: space-between;
      }

      .planner-col--center {
        justify-content: center;
      }

      .planner-spacer {
        flex: 1 1 auto;
      }

      .slot-card {
        background: var(--bg-panel);
        border: 1px solid var(--border-soft);
        border-radius: 10px;
        padding: 0.9rem;
        min-height: 120px;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.25);
        display: flex;
        flex-direction: column;
        gap: 0.65rem;
        position: relative;
        overflow: hidden;
      }

      .slot-clear {
        position: absolute;
        top: 6px;
        right: 6px;
        background: rgba(0, 0, 0, 0.35);
        border: 1px solid var(--border-soft);
        color: var(--text-main);
        width: 22px;
        height: 22px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-weight: 700;
        font-size: 0.85rem;
        line-height: 1;
        opacity: 0;
        transition: opacity 0.15s ease, transform 0.15s ease;
      }

      .slot-card.has-item .slot-clear {
        opacity: 1;
        transform: translateY(0);
      }

      .slot-card::after {
        content: "";
        position: absolute;
        inset: 0;
        background: radial-gradient(circle at 20% 20%, rgba(255, 255, 255, 0.05), transparent 45%);
        pointer-events: none;
      }

      .slot-label {
        text-transform: uppercase;
        letter-spacing: 0.06em;
        font-size: 0.8rem;
        color: var(--text-muted);
      }

      .slot-name {
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--text-main);
      }

      .slot-placeholder {
        border: 1px dashed var(--border-soft);
        border-radius: 8px;
        padding: 0.6rem 0.8rem;
        color: var(--text-muted);
        background: rgba(255, 255, 255, 0.02);
        min-height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .slot-visual {
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 96px;
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid var(--border-soft);
        overflow: hidden;
        position: relative;
      }

      .slot-image {
        display: none;
        width: 32px;
        height: 32px;
        image-rendering: pixelated;
        image-rendering: crisp-edges;
        object-fit: contain;
      }

      .slot-placeholder--small {
        margin: 0;
        border: none;
        background: transparent;
      }

      .slot-rarity {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex-wrap: wrap;
      }

      .rarity-buttons {
        display: inline-flex;
        gap: 0.3rem;
      }

      .rarity-btn {
        border: 1px solid var(--border-soft);
        background: var(--bg-panel-dark);
        color: var(--text-main);
        border-radius: 6px;
        padding: 0.15rem 0.5rem;
        cursor: pointer;
      }

      .rarity-btn:disabled {
        opacity: 0.4;
        cursor: not-allowed;
      }

      .rarity-label {
        font-weight: 700;
        color: var(--text-main);
        min-width: 70px;
      }

      .rarity-max {
        color: var(--text-muted);
        font-size: 0.85rem;
      }

      .search-bar {
        margin: 0 0 1rem;
        position: relative;
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 0.75rem;
      }

      .search-input {
        width: min(520px, 100%);
        padding: 0.65rem 0.75rem;
        border-radius: 10px;
        border: 1px solid var(--border-soft);
        background: var(--bg-panel-dark);
        color: var(--text-main);
      }

      .search-suggestions {
        position: absolute;
        top: 110%;
        left: 0;
        width: min(520px, 100%);
        background: var(--bg-panel);
        border: 1px solid var(--border-soft);
        border-radius: 10px;
        box-shadow: 0 12px 32px rgba(0, 0, 0, 0.35);
        z-index: 10;
        max-height: 280px;
        overflow: auto;
      }

      .share-button {
        padding: 0.65rem 0.9rem;
        border-radius: 10px;
        border: 1px solid var(--border-soft);
        background: var(--bg-panel);
        color: var(--text-main);
        cursor: pointer;
        transition: background 0.15s ease, border-color 0.15s ease;
      }

      .share-button:hover,
      .share-button:focus-visible {
        background: var(--bg-panel-dark);
        border-color: var(--accent);
      }

      .slot-extra-perk {
        display: none;
        flex-wrap: wrap;
        gap: 0.4rem;
        align-items: center;
      }

      .slot-extra-perk label {
        font-size: 0.85rem;
        color: var(--text-muted);
      }

      .slot-extra-perk select {
        background: var(--bg-panel-dark);
        color: var(--text-main);
        border: 1px solid var(--border-soft);
        border-radius: 8px;
        padding: 0.35rem 0.5rem;
      }

      .suggestion {
        padding: 0.65rem 0.75rem;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        gap: 0.15rem;
      }

      .suggestion:hover,
      .suggestion:focus-visible {
        background: var(--bg-panel-dark);
      }

      .suggestion-title {
        font-weight: 700;
        color: var(--text-main);
      }

      .suggestion-meta {
        font-size: 0.85rem;
        color: var(--text-muted);
      }

      .summary-section {
        margin-top: 1.5rem;
        border-top: 1px solid var(--border-soft);
        padding-top: 1.25rem;
      }

      .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 0.75rem;
      }

      .summary-card {
        background: var(--bg-panel);
        border: 1px solid var(--border-soft);
        border-radius: 10px;
        padding: 0.85rem;
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
      }

      .summary-label {
        text-transform: uppercase;
        letter-spacing: 0.05em;
        font-size: 0.8rem;
        color: var(--text-muted);
      }

      .summary-value {
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--text-main);
      }

      .summary-list {
        display: flex;
        flex-wrap: wrap;
        gap: 0.3rem 0.5rem;
        font-size: 0.95rem;
      }
    </style>
  </head>
  <body>
    <div class="layout">
      <div id="sidebar-root"></div>
      <main class="main-content">
        <header class="content-header">
          <h1 class="content-title">Build Planner</h1>
        </header>

        <article class="content-section planner-section">
          <p class="content-description">Search for items to add them.</p>

          <div class="search-bar">
            <input
              type="text"
              id="gear-search"
              class="search-input"
              placeholder="Search weapons or armors..."
              autocomplete="off"
            />
            <button type="button" id="share-build" class="share-button">Share Build</button>
            <div id="gear-suggestions" class="search-suggestions" style="display: none"></div>
          </div>

          <div class="planner-grid">
            <div class="planner-col planner-col--center">
              <div class="slot-card" data-slot="Gauntlets">
                <button type="button" class="slot-clear" aria-label="Clear slot">&times;</button>
                <div class="slot-name">Gauntlets</div>
                <div class="slot-visual">
                  <img class="slot-image" alt="Gauntlets preview" />
                  <div class="slot-placeholder slot-placeholder--small"></div>
                </div>
                <div class="slot-rarity">
                  <div class="rarity-buttons">
                    <button type="button" class="rarity-btn" data-rarity-dec>-</button>
                    <button type="button" class="rarity-btn" data-rarity-inc>+</button>
                  </div>
                  <div class="rarity-label" data-rarity-label>—</div>
                  <div class="rarity-max" data-rarity-max>Max: —</div>
                </div>
                <div class="slot-extra-perk" data-perk-row>
                  <label>Extra Perk:</label>
                  <select data-perk-select>
                    <option value="">Select perk</option>
                  </select>
                  <select data-perk-tier>
                    <option value="1">Tier 1</option>
                    <option value="2">Tier 2</option>
                    <option value="3">Tier 3</option>
                  </select>
                </div>
              </div>
              <div class="slot-card" data-slot="Shield">
                <button type="button" class="slot-clear" aria-label="Clear slot">&times;</button>
                <div class="slot-name">Shield</div>
                <div class="slot-visual">
                  <img class="slot-image" alt="Shield preview" />
                  <div class="slot-placeholder slot-placeholder--small"></div>
                </div>
                <div class="slot-rarity">
                  <div class="rarity-buttons">
                    <button type="button" class="rarity-btn" data-rarity-dec>-</button>
                    <button type="button" class="rarity-btn" data-rarity-inc>+</button>
                  </div>
                  <div class="rarity-label" data-rarity-label>—</div>
                  <div class="rarity-max" data-rarity-max>Max: —</div>
                </div>
                <div class="slot-extra-perk" data-perk-row>
                  <label>Extra Perk:</label>
                  <select data-perk-select>
                    <option value="">Select perk</option>
                  </select>
                  <select data-perk-tier>
                    <option value="1">Tier 1</option>
                    <option value="2">Tier 2</option>
                    <option value="3">Tier 3</option>
                  </select>
                </div>
              </div>
            </div>

            <div class="planner-col planner-col--stacked">
              <div class="slot-card" data-slot="Helmet">
                <button type="button" class="slot-clear" aria-label="Clear slot">&times;</button>
                <div class="slot-name">Helmet</div>
                <div class="slot-visual">
                  <img class="slot-image" alt="Helmet preview" />
                  <div class="slot-placeholder slot-placeholder--small"></div>
                </div>
                <div class="slot-rarity">
                  <div class="rarity-buttons">
                    <button type="button" class="rarity-btn" data-rarity-dec>-</button>
                    <button type="button" class="rarity-btn" data-rarity-inc>+</button>
                  </div>
                  <div class="rarity-label" data-rarity-label>—</div>
                  <div class="rarity-max" data-rarity-max>Max: —</div>
                </div>
                <div class="slot-extra-perk" data-perk-row>
                  <label>Extra Perk:</label>
                  <select data-perk-select>
                    <option value="">Select perk</option>
                  </select>
                  <select data-perk-tier>
                    <option value="1">Tier 1</option>
                    <option value="2">Tier 2</option>
                    <option value="3">Tier 3</option>
                  </select>
                </div>
              </div>
              <div class="slot-card" data-slot="Chest">
                <button type="button" class="slot-clear" aria-label="Clear slot">&times;</button>
                <div class="slot-name">Chest</div>
                <div class="slot-visual">
                  <img class="slot-image" alt="Chest preview" />
                  <div class="slot-placeholder slot-placeholder--small"></div>
                </div>
                <div class="slot-rarity">
                  <div class="rarity-buttons">
                    <button type="button" class="rarity-btn" data-rarity-dec>-</button>
                    <button type="button" class="rarity-btn" data-rarity-inc>+</button>
                  </div>
                  <div class="rarity-label" data-rarity-label>—</div>
                  <div class="rarity-max" data-rarity-max>Max: —</div>
                </div>
                <div class="slot-extra-perk" data-perk-row>
                  <label>Extra Perk:</label>
                  <select data-perk-select>
                    <option value="">Select perk</option>
                  </select>
                  <select data-perk-tier>
                    <option value="1">Tier 1</option>
                    <option value="2">Tier 2</option>
                    <option value="3">Tier 3</option>
                  </select>
                </div>
              </div>
              <div class="slot-card" data-slot="Leggings">
                <button type="button" class="slot-clear" aria-label="Clear slot">&times;</button>
                <div class="slot-name">Leggings</div>
                <div class="slot-visual">
                  <img class="slot-image" alt="Leggings preview" />
                  <div class="slot-placeholder slot-placeholder--small"></div>
                </div>
                <div class="slot-rarity">
                  <div class="rarity-buttons">
                    <button type="button" class="rarity-btn" data-rarity-dec>-</button>
                    <button type="button" class="rarity-btn" data-rarity-inc>+</button>
                  </div>
                  <div class="rarity-label" data-rarity-label>—</div>
                  <div class="rarity-max" data-rarity-max>Max: —</div>
                </div>
                <div class="slot-extra-perk" data-perk-row>
                  <label>Extra Perk:</label>
                  <select data-perk-select>
                    <option value="">Select perk</option>
                  </select>
                  <select data-perk-tier>
                    <option value="1">Tier 1</option>
                    <option value="2">Tier 2</option>
                    <option value="3">Tier 3</option>
                  </select>
                </div>
              </div>
            </div>

            <div class="planner-col planner-col--center">
              <div class="slot-card" data-slot="Weapon">
                <button type="button" class="slot-clear" aria-label="Clear slot">&times;</button>
                <div class="slot-name">Weapon</div>
                <div class="slot-visual">
                  <img class="slot-image" alt="Weapon preview" />
                  <div class="slot-placeholder slot-placeholder--small"></div>
                </div>
                <div class="slot-rarity">
                  <div class="rarity-buttons">
                    <button type="button" class="rarity-btn" data-rarity-dec>-</button>
                    <button type="button" class="rarity-btn" data-rarity-inc>+</button>
                  </div>
                  <div class="rarity-label" data-rarity-label>—</div>
                  <div class="rarity-max" data-rarity-max>Max: —</div>
                </div>
                <div class="slot-extra-perk" data-perk-row>
                  <label>Extra Perk:</label>
                  <select data-perk-select>
                    <option value="">Select perk</option>
                  </select>
                  <select data-perk-tier>
                    <option value="1">Tier 1</option>
                    <option value="2">Tier 2</option>
                    <option value="3">Tier 3</option>
                  </select>
                </div>
              </div>
              <div class="slot-card" data-slot="Cosmetic">
                <button type="button" class="slot-clear" aria-label="Clear slot">&times;</button>
                <div class="slot-name">Cosmetic</div>
                <div class="slot-visual">
                  <img class="slot-image" alt="Cosmetic preview" />
                  <div class="slot-placeholder slot-placeholder--small"></div>
                </div>
                <div class="slot-rarity">
                  <div class="rarity-buttons">
                    <button type="button" class="rarity-btn" data-rarity-dec>-</button>
                    <button type="button" class="rarity-btn" data-rarity-inc>+</button>
                  </div>
                  <div class="rarity-label" data-rarity-label>—</div>
                  <div class="rarity-max" data-rarity-max>Max: —</div>
                </div>
                <div class="slot-extra-perk" data-perk-row>
                  <label>Extra Perk:</label>
                  <select data-perk-select>
                    <option value="">Select perk</option>
                  </select>
                  <select data-perk-tier>
                    <option value="1">Tier 1</option>
                    <option value="2">Tier 2</option>
                    <option value="3">Tier 3</option>
                  </select>
                </div>
              </div>
            </div>
          </div>
        </article>

        <section class="summary-section">
          <h3>Combined Stats</h3>
          <div class="summary-grid">
            <div class="summary-card">
              <div class="summary-label">Armor</div>
              <div class="summary-value" id="sum-armor">0</div>
            </div>
            <div class="summary-card">
              <div class="summary-label">Weight</div>
              <div class="summary-value" id="sum-weight">0</div>
            </div>
            <div class="summary-card">
              <div class="summary-label">DPS</div>
              <div class="summary-value" id="sum-dps">0</div>
            </div>
            <div class="summary-card">
              <div class="summary-label">Element</div>
              <div class="summary-value" id="sum-element">None</div>
            </div>
            <div class="summary-card">
              <div class="summary-label">To Hit</div>
              <div class="summary-value" id="sum-tohit">0</div>
            </div>
            <div class="summary-card">
              <div class="summary-label">Strength</div>
              <div class="summary-value" id="sum-str">0</div>
            </div>
            <div class="summary-card">
              <div class="summary-label">Constitution</div>
              <div class="summary-value" id="sum-con">0</div>
            </div>
            <div class="summary-card">
              <div class="summary-label">Dexterity</div>
              <div class="summary-value" id="sum-dex">0</div>
            </div>
            <div class="summary-card">
              <div class="summary-label">Resistances</div>
              <div class="summary-value summary-list" id="sum-resists">None</div>
            </div>
            <div class="summary-card">
              <div class="summary-label">Innate Perks</div>
              <div class="summary-value summary-list" id="sum-perks">None</div>
            </div>
          </div>
        </section>
      </main>
    </div>

    <script>
      (function () {
        const searchInput = document.getElementById("gear-search");
        const suggestionsEl = document.getElementById("gear-suggestions");
        const slotEls = new Map(
          Array.from(document.querySelectorAll(".slot-card")).map((card) => [card.dataset.slot, card])
        );
        const RARITY_TIERS = [
          { label: "Common", statMin: 0, statMax: 0, bonusAC: 0 },
          { label: "Uncommon", statMin: 2, statMax: 5, bonusAC: 0 },
          { label: "Rare", statMin: 6, statMax: 10, bonusAC: 0 },
          { label: "Epic", statMin: 11, statMax: 15, bonusAC: 2 },
          { label: "Legendary", statMin: 16, statMax: 20, bonusAC: 3 },
          { label: "Mythical", statMin: 21, statMax: 25, bonusAC: 4 },
          { label: "Ascendant", statMin: 26, statMax: 30, bonusAC: 5 },
        ];

        const rarityLabelIndex = RARITY_TIERS.reduce((acc, tier, idx) => {
          acc[tier.label.toLowerCase()] = idx;
          return acc;
        }, {});

        const RARITY_COLORS = {
          Common: "#ffffff",
          Uncommon: "#ffd966",
          Rare: "#0000ff",
          Epic: "#741b47",
          Legendary: "#ff9900",
          Mythical: "#6aa84f",
          Ascendant: "#ff0000",
        };

        const RESIST_COLORS = {
          fire: "#ff5a5a",
          electric: "#b86bff",
          poison: "#2f7a2f",
          cold: "#7cc9ff",
          acid: "#b38b00",
          disease: "#ff9c42",
        };

        const normalizeRarityLabel = (label) => {
          const lower = String(label || "").toLowerCase().trim();
          if (!lower) return null;
          if (lower === "normal" || lower === "regular" || lower === "common") return "Common";
          return RARITY_TIERS.find((t) => t.label.toLowerCase() === lower)?.label || null;
        };

        const rarityIndexFromLabel = (label) => {
          const normalized = normalizeRarityLabel(label);
          if (!normalized) return 0;
          return rarityLabelIndex[normalized.toLowerCase()] ?? 0;
        };

        const rarityLabelFromValue = (value) => {
          if (value === null || value === undefined || value === "") return null;
          if (typeof value === "number") {
            return RARITY_TIERS[value] ? RARITY_TIERS[value].label : null;
          }
          return normalizeRarityLabel(value);
        };

        const totals = {
          armor: document.getElementById("sum-armor"),
          weight: document.getElementById("sum-weight"),
          dps: document.getElementById("sum-dps"),
          element: document.getElementById("sum-element"),
          toHit: document.getElementById("sum-tohit"),
          str: document.getElementById("sum-str"),
          con: document.getElementById("sum-con"),
          dex: document.getElementById("sum-dex"),
          resists: document.getElementById("sum-resists"),
          perks: document.getElementById("sum-perks"),
        };

        const selectedBySlot = {};
        const STATE_PARAM = "build";
        let perkOptions = [];

        const deriveImageCandidates = (item, folder = "weapons") => {
          const candidates = [];
          const direct = typeof item === "string" ? item : item && item.image;
          if (direct) candidates.push(direct);
          const name = (item && (item.name || item.Name || item.id)) || "";
          const safeName = String(name).replace(/[\\/:*?"<>|]/g, "").trim();
          if (safeName) {
            const bases = [
              `images/${folder}`,
              `../images/${folder}`,
              `../../images/${folder}`,
              `/images/${folder}`,
            ];
            bases.forEach((base) => {
              const encoded = encodeURI(`${base}/${safeName}`);
              candidates.push(`${encoded}.gif`, `${encoded}.GIF`, `${encoded}.png`, `${encoded}.PNG`);
            });
          }
          return Array.from(new Set(candidates.filter(Boolean)));
        };

        const setSlotImage = (slot, item, folder) => {
          const card = slotEls.get(slot);
          if (!card) return;
          const img = card.querySelector(".slot-image");
          const placeholder = card.querySelector(".slot-placeholder");
          if (!img || !placeholder) return;
          card.classList.add("has-item");
          const titleEl = card.querySelector(".slot-name");
          if (titleEl) {
            titleEl.textContent = item?.name || card.dataset.slot || "";
          }
          const maxRarityLabel = item.maxRarityLabel || item.max_rarity_label || item.max_rarity;
          const maxRarityIndex = Math.min(
            RARITY_TIERS.length - 1,
            rarityIndexFromLabel(maxRarityLabel !== undefined ? maxRarityLabel : 0)
          );
          const rarityIndex = 0; // start at Common regardless of current selection
          selectedBySlot[slot] = {
            ...item,
            rarityIndex,
            maxRarityIndex,
            bonusStr: 0,
            bonusDex: 0,
            bonusCon: 0,
            bonusAC: 0,
            bonusResists: { fire: 0, cold: 0, electric: 0, acid: 0, poison: 0, disease: 0 },
          };
          rollRarityBonuses(slot);
          updateSlotRarityUI(slot);
          updateSlotPerkUI(slot);
          const sources = deriveImageCandidates(item, folder);
          if (!sources.length) {
            img.style.display = "none";
            placeholder.style.display = "flex";
            updateTotals();
            return;
          }
          let index = 0;
          const trySet = () => {
            img.onload = () => {
              img.style.display = "block";
              placeholder.style.display = "none";
              updateTotals();
            };
            img.onerror = () => {
              index += 1;
              if (index < sources.length) {
                trySet();
              } else {
                img.style.display = "none";
                placeholder.style.display = "flex";
                updateTotals();
              }
            };
            img.src = sources[index];
          };
          trySet();
          persistState();
        };

        const clearSlot = (slot) => {
          const card = slotEls.get(slot);
          if (!card) return;
          const img = card.querySelector(".slot-image");
          const placeholder = card.querySelector(".slot-placeholder");
          const titleEl = card.querySelector(".slot-name");
          if (img) {
            img.removeAttribute("src");
            img.style.display = "none";
          }
          if (placeholder) {
            placeholder.style.display = "flex";
          }
          if (titleEl) {
            titleEl.textContent = card.dataset.slot || "";
          }
          card.classList.remove("has-item");
          delete selectedBySlot[slot];
          updateSlotPerkUI(slot, true);
          updateSlotRarityUI(slot);
          updateTotals();
          persistState();
        };

        const dataset = {
          weapons: [],
          armors: [],
        };

        const encodeState = () => {
          const entries = Object.entries(selectedBySlot).map(([slot, item]) => ({
            slot,
            name: item.name,
            kind: item.kind,
            rarityIndex: item.rarityIndex,
            extraPerkName: item.extraPerkName || null,
            extraPerkTier: item.extraPerkTier || null,
          }));
          return { slots: entries };
        };

        const persistState = () => {
          try {
            const state = encodeState();
            const json = JSON.stringify(state);
            const encoded = btoa(encodeURIComponent(json));
            const url = new URL(window.location.href);
            if (state.slots.length) {
              url.searchParams.set(STATE_PARAM, encoded);
            } else {
              url.searchParams.delete(STATE_PARAM);
            }
            window.history.replaceState({}, "", url.toString());
          } catch (error) {
            /* ignore */
          }
        };

        const decodeState = () => {
          try {
            const url = new URL(window.location.href);
            const encoded = url.searchParams.get(STATE_PARAM);
            if (!encoded) return null;
            const json = decodeURIComponent(atob(encoded));
            const state = JSON.parse(json);
            if (!state || !Array.isArray(state.slots)) return null;
            return state;
          } catch (error) {
            return null;
          }
        };

        const applySavedState = () => {
          const state = decodeState();
          if (!state) return;
          const findItem = (kind, name) => {
            const list = kind === "weapon" ? dataset.weapons : dataset.armors;
            const lower = String(name || "").toLowerCase();
            return list.find((item) => String(item.name || "").toLowerCase() === lower);
          };
          state.slots.forEach((entry) => {
            const item = findItem(entry.kind, entry.name);
            if (!item) return;
            const folder = entry.kind === "weapon" ? "weapons" : "armors";
            setSlotImage(entry.slot, item, folder);
            if (selectedBySlot[entry.slot]) {
              const data = selectedBySlot[entry.slot];
              data.rarityIndex = Math.min(data.maxRarityIndex, Math.max(0, Number(entry.rarityIndex) || 0));
              data.extraPerkName = entry.extraPerkName || null;
              data.extraPerkTier = entry.extraPerkTier || null;
              rollRarityBonuses(entry.slot);
              updateSlotRarityUI(entry.slot);
              updateSlotPerkUI(entry.slot);
            }
          });
          updateTotals();
        };

        const toNumber = (value) => {
          const num = Number(value);
          return Number.isNaN(num) ? 0 : num;
        };

        const sumObjects = (list, key) => list.reduce((acc, obj) => acc + toNumber(obj?.[key]), 0);

        const allocateStats = (total) => {
          let remaining = Math.max(0, Math.round(total));
          const dist = { str: 0, dex: 0, con: 0 };
          const keys = ["str", "dex", "con"];
          while (remaining > 0) {
            const key = keys[Math.floor(Math.random() * keys.length)];
            dist[key] += 1;
            remaining -= 1;
          }
          return dist;
        };

        const toArmor = (raw) => {
          const fields = (raw && raw.fields) || {};
          const electric = fields.electric_resistance ?? fields.lightning_resistance;
          return {
            kind: "armor",
            name: raw.name || raw.Name,
            slot: fields.slot_label || fields.slot || "",
            image: raw.image || raw.icon || raw.thumbnail || "",
            maxRarityLabel: fields.max_rarity_label || fields.max_rarity,
            armor: toNumber(fields.armor),
            weight: toNumber(fields.weight),
            toHit: toNumber(fields.to_hit),
            strength: toNumber(fields.strength),
            constitution: toNumber(fields.constitution),
            dexterity: toNumber(fields.dexterity),
            resistances: {
              fire: toNumber(fields.fire_resistance),
              cold: toNumber(fields.cold_resistance),
              electric: toNumber(electric),
              acid: toNumber(fields.acid_resistance),
              poison: toNumber(fields.poison_resistance),
              disease: toNumber(fields.disease_resistance),
            },
            perk: fields.perk ? fields.perk_label || fields.perk : null,
          };
        };

        const computeDps = (minDamage, maxDamage, attackSpeed) => {
          const min = Number(minDamage);
          const max = Number(maxDamage);
          const speed = Number(attackSpeed);
          if (Number.isNaN(min) || Number.isNaN(max) || Number.isNaN(speed) || speed === 0) return 0;
          const avgDamage = (min + max) / 2;
          return Number((avgDamage * (1000 / speed)).toFixed(2));
        };

        const toWeapon = (raw) => {
          const fields = (raw && raw.fields) || {};
          const dps = computeDps(fields.min_damage, fields.max_damage, fields.attack_speed);
          return {
            kind: "weapon",
            name: raw.name || raw.Name,
            slot: "Weapon",
            image: raw.image || raw.icon || raw.thumbnail || "",
            maxRarityLabel: fields.max_rarity_label || fields.max_rarity,
            dps,
            element: fields.element_label || (fields.element ? fields.element : "None"),
            toHit: toNumber(fields.to_hit),
            strength: toNumber(fields.strength),
            constitution: toNumber(fields.constitution),
            dexterity: toNumber(fields.dexterity),
            resistances: {
              fire: toNumber(fields.fire_resistance),
              cold: toNumber(fields.cold_resistance),
              electric: toNumber(fields.electric_resistance),
              acid: toNumber(fields.acid_resistance),
              poison: toNumber(fields.poison_resistance),
              disease: toNumber(fields.disease_resistance),
            },
            perk: fields.perk ? fields.perk_label || fields.perk : null,
          };
        };

        const formatResists = (res) => {
          const entries = [];
          const labels = {
            fire: "Fire",
            cold: "Cold",
            electric: "Electric",
            acid: "Acid",
            poison: "Poison",
            disease: "Disease",
          };
          Object.entries(res).forEach(([key, val]) => {
            if (toNumber(val) !== 0) {
              entries.push({ label: labels[key], value: toNumber(val), color: RESIST_COLORS[key] });
            }
          });
          return entries;
        };

        const rollRarityBonuses = (slot) => {
          const data = selectedBySlot[slot];
          if (!data) return;
          const tier = RARITY_TIERS[data.rarityIndex] || RARITY_TIERS[0];
          const statTotal =
            tier.statMin === tier.statMax
              ? tier.statMin
              : Math.floor(Math.random() * (tier.statMax - tier.statMin + 1)) + tier.statMin;
          const stats = allocateStats(statTotal);
          data.bonusStr = stats.str;
          data.bonusDex = stats.dex;
          data.bonusCon = stats.con;
          data.bonusAC = tier.bonusAC;
          data.bonusResists = { fire: 0, cold: 0, electric: 0, acid: 0, poison: 0, disease: 0 };
        };

        const updateSlotPerkUI = (slot, clearOnly = false) => {
          const card = slotEls.get(slot);
          if (!card) return;
          const row = card.querySelector("[data-perk-row]");
          const select = card.querySelector("[data-perk-select]");
          const tierSelect = card.querySelector("[data-perk-tier]");
          const data = selectedBySlot[slot];

          if (clearOnly || !data || data.rarityIndex < 3) {
            if (row) row.style.display = "none";
            if (select) select.value = "";
            if (tierSelect) tierSelect.value = "1";
            if (data) {
              data.extraPerkName = null;
              data.extraPerkTier = null;
            }
            return;
          }

          if (row) row.style.display = "flex";

          const ensureOptions = () => {
            if (!select) return;
            if (select.dataset.bound === "true") return;
            select.innerHTML = '<option value="">Select perk</option>';
            perkOptions.forEach((name) => {
              const opt = document.createElement("option");
              opt.value = name;
              opt.textContent = name;
              select.appendChild(opt);
            });
            select.dataset.bound = "true";
            select.addEventListener("change", () => {
              data.extraPerkName = select.value || null;
              persistState();
              updateTotals();
            });
            if (tierSelect) {
              tierSelect.addEventListener("change", () => {
                data.extraPerkTier = Number(tierSelect.value) || 1;
                persistState();
                updateTotals();
              });
            }
          };

          ensureOptions();

          if (select) select.value = data.extraPerkName || "";
          if (tierSelect) tierSelect.value = String(data.extraPerkTier || 1);
        };

        const updateSlotRarityUI = (slot) => {
          const card = slotEls.get(slot);
          if (!card) return;
          const labelEl = card.querySelector("[data-rarity-label]");
          const maxEl = card.querySelector("[data-rarity-max]");
          const incBtn = card.querySelector("[data-rarity-inc]");
          const decBtn = card.querySelector("[data-rarity-dec]");
          const data = selectedBySlot[slot];

          if (!data) {
            if (labelEl) labelEl.textContent = "—";
            if (maxEl) maxEl.textContent = "Max: —";
            if (incBtn) incBtn.disabled = true;
            if (decBtn) decBtn.disabled = true;
            if (labelEl) labelEl.style.color = "var(--text-main)";
            return;
          }

          const tier = RARITY_TIERS[data.rarityIndex] || RARITY_TIERS[0];
          const maxTier = RARITY_TIERS[data.maxRarityIndex] || RARITY_TIERS[RARITY_TIERS.length - 1];
          if (labelEl) labelEl.textContent = tier.label;
          if (labelEl) labelEl.style.color = RARITY_COLORS[tier.label] || "var(--text-main)";
          if (maxEl) maxEl.textContent = `Max: ${maxTier.label}`;
          if (incBtn) incBtn.disabled = data.rarityIndex >= data.maxRarityIndex;
          if (decBtn) decBtn.disabled = data.rarityIndex <= 0;
          updateSlotPerkUI(slot);
        };

        const updateTotals = () => {
          const selected = Object.values(selectedBySlot || {});
          const armors = selected.filter((i) => i.kind === "armor");
          const weapons = selected.filter((i) => i.kind === "weapon");
          const weapon = weapons[0];

          const totalArmor = sumObjects(armors, "armor") + selected.reduce((acc, a) => acc + toNumber(a.bonusAC), 0);
          const baseArmor = sumObjects(armors, "armor");
          const rarityArmor = selected.reduce((acc, a) => acc + toNumber(a.bonusAC), 0);
          const totalWeight = sumObjects(armors, "weight");
          const totalToHit = sumObjects(selected, "toHit");
          const baseStr = sumObjects(selected, "strength");
          const baseCon = sumObjects(selected, "constitution");
          const baseDex = sumObjects(selected, "dexterity");
          const bonusStr = sumObjects(selected, "bonusStr");
          const bonusCon = sumObjects(selected, "bonusCon");
          const bonusDex = sumObjects(selected, "bonusDex");
          const totalStr = baseStr + bonusStr;
          const totalCon = baseCon + bonusCon;
          const totalDex = baseDex + bonusDex;
          const totalDps = weapon ? toNumber(weapon.dps) : 0;
          const element = weapon && weapon.element ? weapon.element : "None";

          const resistTotals = ["fire", "cold", "electric", "acid", "poison", "disease"].reduce((acc, key) => {
            acc[key] =
              selected.reduce((sum, item) => sum + toNumber(item.resistances?.[key]), 0) +
              selected.reduce((sum, item) => sum + toNumber(item.bonusResists?.[key]), 0);
            return acc;
          }, {});

          const perkSet = new Set(
            selected
              .map((i) => i.perk)
              .filter((p) => p && String(p).trim())
              .map((p) => String(p).trim())
          );
          selected.forEach((i) => {
            if (i.extraPerkName) {
              const tier = i.extraPerkTier || 1;
              perkSet.add(`${i.extraPerkName} (T${tier})`);
            }
          });

          if (totals.armor) totals.armor.textContent = totalArmor;
          if (totals.armor)
            totals.armor.title = `Base armor: ${baseArmor}\nRarity bonus: ${rarityArmor}`;
          if (totals.weight) totals.weight.textContent = totalWeight;
          if (totals.dps) totals.dps.textContent = totalDps;
          if (totals.element) totals.element.textContent = element || "None";
          if (totals.toHit) totals.toHit.textContent = totalToHit;
          if (totals.str) {
            totals.str.textContent = totalStr;
            totals.str.title = `Base: ${baseStr}\nRarity bonus: ${bonusStr}`;
          }
          if (totals.con) {
            totals.con.textContent = totalCon;
            totals.con.title = `Base: ${baseCon}\nRarity bonus: ${bonusCon}`;
          }
          if (totals.dex) {
            totals.dex.textContent = totalDex;
            totals.dex.title = `Base: ${baseDex}\nRarity bonus: ${bonusDex}`;
          }

          if (totals.resists) {
            const list = formatResists(resistTotals);
            if (!list.length) {
              totals.resists.textContent = "None";
            } else {
              totals.resists.innerHTML = "";
              list.forEach((item, idx) => {
                const span = document.createElement("span");
                span.textContent = `${item.label} ${item.value}`;
                if (item.color) span.style.color = item.color;
                totals.resists.appendChild(span);
                if (idx < list.length - 1) {
                  const comma = document.createTextNode(", ");
                  totals.resists.appendChild(comma);
                }
              });
            }
          }

          if (totals.perks) {
            totals.perks.textContent = perkSet.size ? Array.from(perkSet).join(", ") : "None";
          }
        };

        const adjustRarity = (slot, delta) => {
          const data = selectedBySlot[slot];
          if (!data) return;
          const next = Math.min(Math.max(data.rarityIndex + delta, 0), data.maxRarityIndex);
          if (next === data.rarityIndex) return;
          data.rarityIndex = next;
          rollRarityBonuses(slot);
          updateSlotRarityUI(slot);
          updateTotals();
          persistState();
        };

        slotEls.forEach((card, slot) => {
          const inc = card.querySelector("[data-rarity-inc]");
          const dec = card.querySelector("[data-rarity-dec]");
          if (inc) inc.addEventListener("click", () => adjustRarity(slot, 1));
          if (dec) dec.addEventListener("click", () => adjustRarity(slot, -1));
          const clearBtn = card.querySelector(".slot-clear");
          if (clearBtn) clearBtn.addEventListener("click", () => clearSlot(slot));
        });

        const buildSuggestions = (query) => {
          if (!suggestionsEl) return;
          suggestionsEl.innerHTML = "";
          if (!query || query.length < 1) {
            suggestionsEl.style.display = "none";
            return;
          }
          const term = query.toLowerCase();
          const matches = [...dataset.weapons, ...dataset.armors]
            .filter((item) => (item.name || "").toLowerCase().includes(term))
            .slice(0, 12);
          if (!matches.length) {
            suggestionsEl.style.display = "none";
            return;
          }

          matches.forEach((item) => {
            const div = document.createElement("div");
            div.className = "suggestion";
            div.tabIndex = 0;

            const title = document.createElement("div");
            title.className = "suggestion-title";
            title.textContent = item.name || "Unknown";

            const meta = document.createElement("div");
            meta.className = "suggestion-meta";
            meta.textContent = `${item.kind === "weapon" ? "Weapon" : "Armor"} • Slot: ${item.slot || "—"}`;

            div.appendChild(title);
            div.appendChild(meta);

            const handleSelect = () => {
              const targetSlot = item.slot || "Weapon";
              setSlotImage(targetSlot, item, item.kind === "weapon" ? "weapons" : "armors");
              suggestionsEl.style.display = "none";
              searchInput.value = "";
              updateTotals();
            };

            div.addEventListener("click", handleSelect);
            div.addEventListener("keydown", (e) => {
              if (e.key === "Enter" || e.key === " ") {
                e.preventDefault();
                handleSelect();
              }
            });

            suggestionsEl.appendChild(div);
          });

          suggestionsEl.style.display = "block";
        };

        const loadData = () => {
          return Promise.all([
            fetch(new URL("../items/weapons_data05.json", window.location.href)).then((res) =>
              res.ok ? res.json() : []
            ),
            fetch(new URL("../items/armors_data06.json", window.location.href)).then((res) =>
              res.ok ? res.json() : []
            ),
            fetch(new URL("../systems/perks.html", window.location.href))
              .then((res) => (res.ok ? res.text() : ""))
              .then((html) => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, "text/html");
                const names = Array.from(doc.querySelectorAll("#perk-list h3"))
                  .map((node) => node.textContent || "")
                  .map((n) => n.trim())
                  .filter(Boolean);
                perkOptions = Array.from(new Set(names)).sort((a, b) => a.localeCompare(b));
              })
              .catch(() => {
                perkOptions = [];
              }),
          ])
            .then(([weapons, armors]) => {
              dataset.weapons = Array.isArray(weapons) ? weapons.map((w) => toWeapon(w)) : [];
              dataset.armors = Array.isArray(armors) ? armors.map((a) => toArmor(a)) : [];
            })
            .catch(() => {
              dataset.weapons = [];
              dataset.armors = [];
          });
        };

        const copyShareLink = async () => {
          try {
            await navigator.clipboard.writeText(window.location.href);
            const btn = document.getElementById("share-build");
            if (btn) {
              const original = btn.textContent;
              btn.textContent = "Copied!";
              setTimeout(() => {
                btn.textContent = original || "Share Build";
              }, 1200);
            }
          } catch (error) {
            /* ignore clipboard errors */
          }
        };

        if (searchInput) {
          searchInput.addEventListener("input", (e) => buildSuggestions(e.target.value));
          document.addEventListener("click", (e) => {
            if (!suggestionsEl.contains(e.target) && e.target !== searchInput) {
              suggestionsEl.style.display = "none";
            }
          });
        }

        const shareBtn = document.getElementById("share-build");
        if (shareBtn) {
          shareBtn.addEventListener("click", copyShareLink);
        }

        loadData().then(() => {
          applySavedState();
          persistState();
          slotEls.forEach((_, slot) => updateSlotRarityUI(slot));
          updateTotals();
        });
      })();
    </script>
  </body>
</html>
