<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Armors - Project Rogue Codex</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <base href="../../" />
    <link rel="icon" type="image/x-icon" href="images/project-rogue-favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="images/project-rogue-favicon-32.png" />
    <link rel="icon" type="image/png" sizes="64x64" href="images/project-rogue-favicon-64.png" />
    <link rel="icon" type="image/png" sizes="180x180" href="images/project-rogue-favicon-180.png" />
    <link rel="icon" type="image/png" sizes="512x512" href="images/project-rogue-favicon-512.png" />
    <link rel="stylesheet" href="css/styles.css" />
    <script src="js/nav-loader.js" defer></script>
    <style>
      .item-controls {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        align-items: center;
        margin-bottom: 1rem;
      }

      .item-search {
        padding: 0.55rem 0.75rem;
        border: 1px solid var(--border-soft);
        border-radius: 6px;
        background: var(--bg-panel-dark);
        color: var(--text-main);
        width: min(420px, 100%);
      }

      .item-count {
        margin: 0;
        font-size: 0.9rem;
        color: var(--text-muted);
      }

      .items-table-wrapper {
        overflow: visible;
        border: 1px solid var(--border-soft);
        border-radius: 8px;
        background: var(--bg-panel);
        box-shadow: 0 0 0 1px #0b0f16, 0 8px 16px rgba(0, 0, 0, 0.55);
      }

      .items-table {
        width: 100%;
        border-collapse: collapse;
        min-width: 640px;
      }

      .items-table thead {
        background: linear-gradient(to bottom, #303540, #252a33);
        position: sticky;
        top: 0;
        z-index: 3;
      }

      .items-table th,
      .items-table td {
        padding: 0.55rem 0.75rem;
        text-align: left;
        border-bottom: 1px solid #2f333b;
        font-size: 0.92rem;
      }

      .items-table th {
        background: linear-gradient(to bottom, #303540, #252a33);
        position: sticky;
        top: 0;
        z-index: 2;
        cursor: pointer;
        user-select: none;
        letter-spacing: 0.02em;
        color: #f9fafb;
        white-space: nowrap;
      }

      .items-table th .sort-indicator {
        margin-left: 0.35rem;
        font-size: 0.8rem;
        color: var(--text-muted);
      }

      .items-table tbody tr {
        background: var(--bg-panel-dark);
      }

      .items-table tbody tr:nth-child(2n) {
        background: #1d222b;
      }

      .items-table tbody tr:hover {
        background: rgba(75, 255, 75, 0.08);
        cursor: pointer;
      }

      .item-filters {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        margin: 0 0 0.5rem;
      }

      .item-filter {
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
        min-width: 220px;
      }

      .filter-label {
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--text-muted);
        margin: 0;
      }

      .filter-select {
        background: var(--bg-panel-dark);
        color: var(--text-main);
        border: 1px solid var(--border-soft);
        border-radius: 6px;
        padding: 0.35rem 0.45rem;
        min-height: 120px;
        max-height: 180px;
        overflow: auto;
      }

      .filter-select:focus-visible {
        outline: 1px solid var(--accent);
      }

      .filter-select::-webkit-scrollbar {
        width: 10px;
        height: 10px;
      }

      .filter-select::-webkit-scrollbar-track {
        background: #0d1118;
        border-radius: 8px;
      }

      .filter-select::-webkit-scrollbar-thumb {
        background: linear-gradient(180deg, #3a414f, #262c36);
        border: 1px solid var(--border-soft);
        border-radius: 8px;
        box-shadow: inset 0 0 0 1px #0b0f16;
      }

      .filter-select::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(180deg, #4a5262, #2f3642);
      }

      .item-thumb {
        width: 32px;
        height: 32px;
        object-fit: cover;
        border-radius: 6px;
        border: 1px solid var(--border-soft);
        background: #0f1218;
        image-rendering: pixelated;
        image-rendering: crisp-edges;
      }

      .no-image {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 32px;
        min-height: 32px;
        padding: 0.2rem 0.35rem;
        border: 1px solid var(--border-soft);
        border-radius: 6px;
        background: #0f1218;
        color: var(--text-muted);
        font-size: 0.82rem;
        text-align: center;
      }

      .no-image-fallback {
        width: 32px;
        height: 32px;
        display: none;
        align-items: center;
        justify-content: center;
        border: 1px solid var(--border-soft);
        border-radius: 6px;
        background: #0f1218;
        color: var(--text-muted);
        font-size: 0.82rem;
        text-align: center;
      }

      .item-details {
        display: none;
        border: 1px solid var(--border-soft);
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        background: linear-gradient(135deg, #20252e, #141821);
        box-shadow: 0 0 0 1px #0b0f16, 0 12px 22px rgba(0, 0, 0, 0.65);
      }

      .item-details.show {
        display: block;
      }

      .item-details-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 1rem;
        margin-bottom: 0.6rem;
        flex-wrap: wrap;
      }

      .item-details-body {
        display: block;
      }

      .item-title-group {
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .item-details .item-thumb {
        width: 64px;
        height: 64px;
      }

      .item-details .no-image-fallback {
        width: 64px;
        height: 64px;
      }

      .details-button,
      .details-close {
        border: 1px solid var(--border-soft);
        background: linear-gradient(135deg, rgba(50, 60, 75, 0.9), rgba(20, 24, 32, 0.9));
        color: var(--text-main);
        padding: 0.45rem 0.9rem;
        border-radius: 6px;
        cursor: pointer;
        transition: background 0.15s ease, transform 0.1s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        font-weight: 600;
        letter-spacing: 0.02em;
        line-height: 1.2;
        min-height: 2.35rem;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.35);
      }

      .details-button:hover,
      .details-close:hover {
        background: linear-gradient(135deg, rgba(60, 72, 88, 0.95), rgba(26, 30, 40, 0.95));
        transform: translateY(-1px);
      }

      .table-empty {
        text-align: center;
        padding: 1rem;
        color: var(--text-muted);
      }

      .items-table-wrapper::-webkit-scrollbar,
      .item-details::-webkit-scrollbar {
        width: 10px;
        height: 10px;
      }

      .items-table-wrapper::-webkit-scrollbar-track,
      .item-details::-webkit-scrollbar-track {
        background: #0d1118;
        border-radius: 8px;
      }

      .items-table-wrapper::-webkit-scrollbar-thumb,
      .item-details::-webkit-scrollbar-thumb {
        background: linear-gradient(180deg, #3a414f, #262c36);
        border: 1px solid var(--border-soft);
        border-radius: 8px;
        box-shadow: inset 0 0 0 1px #0b0f16;
      }

      .item-details-grid {
        display: grid;
        grid-template-columns: repeat(4, minmax(0, 1fr));
        gap: 0.5rem 1rem;
      }

      .detail-cell {
        padding: 0.3rem 0;
      }

      .detail-divider {
        grid-column: 1 / -1;
        height: 1px;
        margin: 0.35rem 0 0.25rem;
        background: var(--border-soft);
        opacity: 0.6;
      }

      .detail-row {
        display: grid;
        gap: 0.5rem 0.75rem;
        margin-bottom: 0.35rem;
        grid-column: 1 / -1;
      }

      .detail-row-cols-1 {
        grid-template-columns: 1fr;
      }

      .detail-row-cols-2 {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }

      .detail-row-cols-3 {
        grid-template-columns: repeat(3, minmax(140px, 1fr));
      }

      .detail-row-cols-4 {
        grid-template-columns: repeat(4, minmax(0, 1fr));
      }

      .detail-label {
        font-size: 0.78rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--text-muted);
        margin: 0 0 0.1rem;
        display: block;
      }

      .detail-value {
        font-weight: 700;
        color: #fff;
      }

      @media (max-width: 640px) {
        .item-details-grid {
          grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        }
      }
    </style>
  </head>
  <body>
    <div class="layout">
      <div id="sidebar-root"></div>
      <main class="main-content">
        <header class="content-header">
          <h1 class="content-title">Armors</h1>
        </header>

        <section class="item-details" id="item-details" aria-live="polite">
          <div class="item-details-header">
            <div class="item-title-group">
              <div style="display: flex; align-items: center; gap: 0.5rem;">
                <img id="details-image" class="item-thumb" alt="" />
                <div id="details-image-fallback" class="no-image-fallback">No Image</div>
              </div>
              <h2 id="details-name" class="content-title" style="margin: 0"></h2>
            </div>
            <button type="button" class="details-button details-close" id="details-close">Close</button>
          </div>
          <div class="item-details-body">
            <div id="details-properties" class="item-details-grid"></div>
          </div>
        </section>

        <div class="content-section">
          <div class="item-controls">
            <input
              type="search"
              id="item-search"
              class="item-search"
              placeholder="Search armors by any field..."
              aria-label="Search armors"
            />
            <p class="item-count" id="item-count"></p>
          </div>

          <div class="item-filters" aria-label="Filters">
            <div class="item-filter">
              <label class="filter-label" for="filter-slot">Slot</label>
              <select id="filter-slot" class="filter-select" multiple aria-label="Filter by slot"></select>
            </div>
            <div class="item-filter">
              <label class="filter-label" for="filter-resist">Resistances</label>
              <select id="filter-resist" class="filter-select" multiple aria-label="Filter by resistance"></select>
            </div>
          </div>

          <div class="items-table-wrapper">
            <table class="items-table" aria-describedby="item-search">
              <thead>
                <tr id="items-head-row"></tr>
              </thead>
              <tbody id="items-body"></tbody>
            </table>
          </div>
        </div>
      </main>
    </div>

    <script>
      (() => {
        const PAGE = {
          title: "Armors",
          dataFile: "armors_data06.json",
        };

        const dataUrl = new URL(PAGE.dataFile, window.location.href);
        const searchInput = document.getElementById("item-search");
        const slotFilter = document.getElementById("filter-slot");
        const resistFilter = document.getElementById("filter-resist");
        const tableHeadRow = document.getElementById("items-head-row");
        const tableBody = document.getElementById("items-body");
        const countLabel = document.getElementById("item-count");
        const details = document.getElementById("item-details");
        const closeBtn = document.getElementById("details-close");

        const detailFields = {
          name: document.getElementById("details-name"),
          image: document.getElementById("details-image"),
          imageFallback: document.getElementById("details-image-fallback"),
          properties: document.getElementById("details-properties"),
        };

        const COLUMNS = [
          { key: "image", label: "Image", sortable: false },
          { key: "name", label: "Name" },
          { key: "level", label: "Level" },
          { key: "armor", label: "Armor" },
          { key: "fireResist", label: "Fire", format: (v) => formatNumber(v) },
          { key: "poisonResist", label: "Poison", format: (v) => formatNumber(v) },
          { key: "coldResist", label: "Cold", format: (v) => formatNumber(v) },
          { key: "diseaseResist", label: "Disease", format: (v) => formatNumber(v) },
          { key: "acidResist", label: "Acid", format: (v) => formatNumber(v) },
          { key: "electricResist", label: "Electric", format: (v) => formatNumber(v) },
        ];

        let items = [];
        let sortKey = "level";
        let sortDir = "desc";
        let searchTerm = "";
        let selectedSlots = new Set();
        let selectedResists = new Set();
        const HIDDEN_NAMES = new Set(
          [
            "stone of jordan",
            "abyssal core",
            "book of the dead",
            "celestial sceptre",
            "magus robe",
            "book of curses",
            "mystic greaves",
            "holy robe",
            "sages leggings",
            "firestone amulet",
            "sages robe",
            "lich robe",
            "conjurers robe",
            "apprentice leggings",
            "ring of intellect",
            "necklace of intellect",
            "scholars book",
            "sand cloth boots",
            "shield of sands",
            "sand bracelets",
            "truesight frames",
            "sand cloth robe",
          ].map((n) => n.toLowerCase())
        );

        const titleCase = (text) =>
          text
            .replace(/([a-z])([A-Z])/g, "$1 $2")
            .replace(/[_-]+/g, " ")
            .replace(/\s+/g, " ")
            .trim()
            .replace(/\b\w/g, (c) => c.toUpperCase());

        const renderEmpty = (message) => {
          tableHeadRow.innerHTML = "";
          tableBody.innerHTML = `<tr><td class="table-empty" colspan="1">${message}</td></tr>`;
          if (countLabel) {
            countLabel.textContent = "0 results";
          }
        };

        const normalizeSortValue = (value) => {
          if (value === null || value === undefined) return "";
          if (typeof value === "number") return value;
          if (typeof value === "boolean") return value ? 1 : 0;
          if (Array.isArray(value)) return value.join(", ");
          if (typeof value === "object") return JSON.stringify(value);
          return String(value).toLowerCase();
        };

        const formatValue = (value) => {
          if (value === null || value === undefined) return "-";
          if (Array.isArray(value)) return value.join(", ");
          if (typeof value === "object") return JSON.stringify(value);
          return value;
        };

        const formatNumber = (value, options = {}) => {
          if (value === null || value === undefined || value === "") return "-";
          const num = Number(value);
          if (Number.isNaN(num)) return value;
          return num.toLocaleString("en-US", { maximumFractionDigits: 0, ...options });
        };

        const toNumber = (value) => {
          const num = Number(value);
          return Number.isFinite(num) ? num : null;
        };

        const normalizeFilterValue = (value) => (value || "").toString().trim().toLowerCase();

        const setOptions = (select, options) => {
          if (!select) return;
          select.innerHTML = "";
          options.forEach(({ value, label }) => {
            const opt = document.createElement("option");
            opt.value = value;
            opt.textContent = label;
            select.appendChild(opt);
          });
        };

        const enableToggleSelect = (selectEl) => {
          if (!selectEl) return;
          selectEl.addEventListener("mousedown", (event) => {
            const option = event.target;
            if (option && option.tagName === "OPTION") {
              event.preventDefault();
              option.selected = !option.selected;
              selectEl.dispatchEvent(new Event("change", { bubbles: true }));
            }
          });
        };

        const createCell = (labelText, valueContent) => {
          const cell = document.createElement("div");
          cell.className = "detail-cell";
          const label = document.createElement("span");
          label.className = "detail-label";
          label.textContent = labelText;
          const value = document.createElement("div");
          value.className = "detail-value";
          if (valueContent instanceof Node) {
            value.appendChild(valueContent);
          } else {
            value.textContent = valueContent;
          }
          cell.appendChild(label);
          cell.appendChild(value);
          return cell;
        };

        const addDivider = (container) =>
          container.appendChild(Object.assign(document.createElement("div"), { className: "detail-divider" }));

        const addRow = (container, entries, cols) => {
          const row = document.createElement("div");
          row.className = `detail-row detail-row-cols-${cols || 2}`;
          entries.forEach(([label, value]) => row.appendChild(createCell(label, value)));
          container.appendChild(row);
        };

        const updateSortIndicators = () => {
          document.querySelectorAll(".items-table th[data-sort-key]").forEach((th) => {
            const key = th.getAttribute("data-sort-key");
            const indicator = th.querySelector(".sort-indicator");
            const isActive = key === sortKey;
            const ariaSort = isActive ? (sortDir === "asc" ? "ascending" : "descending") : "none";
            th.setAttribute("aria-sort", ariaSort);
            if (indicator) {
              indicator.textContent = isActive ? (sortDir === "asc" ? "\u25B2" : "\u25BC") : "\u2195";
            }
          });
        };

        const normalizeArmor = (raw) => {
          const fields = (raw && raw.fields) || {};
          const valueNum = toNumber(fields.value);
          return {
            id: raw && raw.id ? raw.id : (raw.name || "").toLowerCase().replace(/[^a-z0-9_-]+/g, "-"),
            name: raw.name || "Unknown",
            slot: fields.slot_label || fields.slot,
            level: fields.level,
            armor: fields.armor,
            weight: fields.weight,
            maxRarity: fields.max_rarity_label || fields.max_rarity,
            perk: fields.perk_label || (fields.perk ? fields.perk : "None"),
            value: valueNum,
            sellValue: valueNum !== null ? valueNum / 2 : null,
            promotion: fields.promotion,
            deconstruction: fields.deconstruction,
            toHit: fields.to_hit,
            playerLevelRequirement: toNumber(fields.player_level_requirement),
            resistances: {
              fire: fields.fire_resistance,
              cold: fields.cold_resistance,
              lightning: fields.lightning_resistance,
              acid: fields.acid_resistance,
              poison: fields.poison_resistance,
              disease: fields.disease_resistance,
            },
            fireResist: fields.fire_resistance,
            poisonResist: fields.poison_resistance,
            coldResist: fields.cold_resistance,
            diseaseResist: fields.disease_resistance,
            acidResist: fields.acid_resistance,
            electricResist: fields.lightning_resistance,
            stats: {
              strength: fields.strength,
              constitution: fields.constitution,
              dexterity: fields.dexterity,
            },
          };
        };

        const populateFilters = (data) => {
          const slotOptions = new Map();
          const resistOptions = new Set();

          data.forEach((item) => {
            const slotValue = normalizeFilterValue(item.slot);
            if (slotValue) {
              if (!slotOptions.has(slotValue)) slotOptions.set(slotValue, item.slot);
            }
            const res = item.resistances || {};
            [
              ["fire", res.fire],
              ["poison", res.poison],
              ["cold", res.cold],
              ["disease", res.disease],
              ["acid", res.acid],
              ["electric", res.electric || res.lightning],
            ].forEach(([key, val]) => {
              if (val !== null && val !== undefined && Number(val) !== 0) {
                resistOptions.add(key);
              }
            });
          });

          const slotList = Array.from(slotOptions.entries())
            .sort((a, b) => a[1].localeCompare(b[1]))
            .map(([value, label]) => ({ value, label }));
          const resistLabels = {
            fire: "Fire",
            poison: "Poison",
            cold: "Cold",
            disease: "Disease",
            acid: "Acid",
            electric: "Electric",
          };
          const resistList = Array.from(resistOptions)
            .sort((a, b) => resistLabels[a].localeCompare(resistLabels[b]))
            .map((value) => ({ value, label: resistLabels[value] || value }));

          setOptions(slotFilter, slotList);
          setOptions(resistFilter, resistList);
        };

        const ensureImage = (img, fallback, src) => {
          if (!img || !fallback) return;
          if (!src) {
            img.style.display = "none";
            fallback.style.display = "flex";
            return;
          }
          img.onload = () => {
            img.style.display = "block";
            fallback.style.display = "none";
          };
          img.onerror = () => {
            img.style.display = "none";
            fallback.style.display = "flex";
          };
          img.src = src;
        };

        const buildHead = () => {
          tableHeadRow.innerHTML = "";
          COLUMNS.forEach((col) => {
            const th = document.createElement("th");
            th.setAttribute("scope", "col");

            const labelSpan = document.createElement("span");
            labelSpan.textContent = col.label;
            th.appendChild(labelSpan);

            th.dataset.sortKey = col.key;
            const indicator = document.createElement("span");
            indicator.className = "sort-indicator";
            indicator.setAttribute("aria-hidden", "true");
            indicator.textContent = "\u2195";
            th.appendChild(indicator);

            th.addEventListener("click", () => {
              if (sortKey === col.key) {
                sortDir = sortDir === "asc" ? "desc" : "asc";
              } else {
                sortKey = col.key;
                sortDir = "asc";
              }
              applyFilterAndSort();
            });
            tableHeadRow.appendChild(th);
          });
          updateSortIndicators();
        };

        const setDetails = (item) => {
          if (!item) return;
          detailFields.name.textContent = item.name || "Unknown";
          const imgSrc = item.image || item.icon || item.thumbnail || "";
          ensureImage(detailFields.image, detailFields.imageFallback, imgSrc);

          const container = detailFields.properties;
          container.innerHTML = "";

          addRow(
            container,
            [
              ["Slot", formatValue(item.slot)],
              ["Level", formatNumber(item.level)],
              ["Armor", formatNumber(item.armor)],
              ["Weight", formatNumber(item.weight)],
            ],
            4
          );

          addRow(container, [["To Hit", formatNumber(item.toHit)]], 1);

          addDivider(container);

          addRow(
            container,
            [
              ["Strength", formatNumber((item.stats && item.stats.strength) ?? 0)],
              ["Constitution", formatNumber((item.stats && item.stats.constitution) ?? 0)],
              ["Dexterity", formatNumber((item.stats && item.stats.dexterity) ?? 0)],
              ["", ""],
            ],
            4
          );

          addDivider(container);

          const res = item.resistances || {};
          addRow(
            container,
            [
              ["Fire", formatNumber(res.fire ?? 0)],
              ["Poison", formatNumber(res.poison ?? 0)],
              ["Cold", formatNumber(res.cold ?? 0)],
            ],
            3
          );
          addRow(
            container,
            [
              ["Disease", formatNumber(res.disease ?? 0)],
              ["Acid", formatNumber(res.acid ?? 0)],
              ["Electric", formatNumber(res.lightning ?? res.electric ?? 0)],
            ],
            3
          );

          addDivider(container);

          addRow(container, [["Innate Perk", formatValue(item.perk)]], 1);

          addDivider(container);

          addRow(
            container,
            [
              ["Max Rarity", formatValue(item.maxRarity)],
              ["Promotion", formatNumber(item.promotion)],
              ["Deconstruction", formatNumber(item.deconstruction)],
            ],
            3
          );

          addDivider(container);

          addRow(
            container,
            [["Requirement", `Player Level ${formatNumber(item.playerLevelRequirement)}`]],
            1
          );

          addDivider(container);

          addRow(
            container,
            [
              ["Value", formatNumber(item.value)],
              ["Sell Value", formatNumber(item.sellValue, { maximumFractionDigits: 2 })],
            ],
            2
          );

          details.classList.add("show");
          details.scrollIntoView({ behavior: "smooth", block: "start" });
        };

        const clearDetails = () => {
          details.classList.remove("show");
        };

        const renderTable = (rows) => {
          if (!rows.length) {
            renderEmpty("No armors match your filters.");
            return;
          }

          const fragment = document.createDocumentFragment();

          rows.forEach((item) => {
            const tr = document.createElement("tr");
            tr.dataset.id = item.id || "";

            COLUMNS.forEach((col) => {
              const td = document.createElement("td");
              const value = item[col.key];
              if (col.key === "image") {
                const img = document.createElement("img");
                img.className = "item-thumb";
                img.alt = `${item.name || "Item"} image`;
                const fallback = document.createElement("span");
                fallback.className = "no-image";
                fallback.textContent = "No Image";
                ensureImage(img, fallback, value);
                if (img.src) {
                  td.appendChild(img);
                } else {
                  td.appendChild(fallback);
                }
              } else if (col.format) {
                td.textContent = col.format(value);
              } else {
                td.textContent = formatValue(value);
              }
              tr.appendChild(td);
            });

            tr.addEventListener("click", () => setDetails(item));
            fragment.appendChild(tr);
          });

          tableBody.innerHTML = "";
          tableBody.appendChild(fragment);
        };

        const applyFilterAndSort = () => {
          if (!Array.isArray(items) || !items.length) {
            renderEmpty("No armors found in armors_data06.json.");
            return;
          }

          const filtered = items.filter((item) => {
            const matchesSlot = selectedSlots.size === 0 || selectedSlots.has(normalizeFilterValue(item.slot));
            if (!matchesSlot) return false;

            if (selectedResists.size) {
              const res = item.resistances || {};
              const resMap = {
                fire: res.fire,
                poison: res.poison,
                cold: res.cold,
                disease: res.disease,
                acid: res.acid,
                electric: res.electric || res.lightning,
              };
              const hasAll = Array.from(selectedResists).every(
                (key) => resMap[key] !== null && resMap[key] !== undefined && Number(resMap[key]) !== 0
              );
              if (!hasAll) return false;
            }

            if (!searchTerm) return true;
            const text = COLUMNS
              .map((col) => formatValue(item[col.key]))
              .join(" ")
              .toLowerCase();
            return text.includes(searchTerm.toLowerCase());
          });

          const sorted = filtered.sort((a, b) => {
            const av = normalizeSortValue(a[sortKey]);
            const bv = normalizeSortValue(b[sortKey]);
            if (av < bv) return sortDir === "asc" ? -1 : 1;
            if (av > bv) return sortDir === "asc" ? 1 : -1;
            return 0;
          });

          updateSortIndicators();

          if (countLabel) {
            const count = sorted.length;
            countLabel.textContent = `${count} result${count === 1 ? "" : "s"}`;
          }

          renderTable(sorted);
        };

        const init = () => {
          fetch(dataUrl.toString())
            .then((response) => {
              if (!response.ok) {
                throw new Error("Failed to load armors_data06.json");
              }
              return response.json();
            })
            .then((data) => {
              items = (Array.isArray(data) ? data : [])
                .map((row) => normalizeArmor(row))
                .filter((row) => !HIDDEN_NAMES.has((row.name || "").toLowerCase()));
              if (!items.length) {
                renderEmpty("Add armors_data06.json beside this page to see armors.");
                return;
              }
              sortKey = "level";
              sortDir = "desc";
              buildHead();
              populateFilters(items);
              applyFilterAndSort();
            })
            .catch(() => {
              renderEmpty("Unable to load armors. Add armors_data06.json beside this page.");
            });
        };

        if (searchInput) {
          searchInput.addEventListener("input", (event) => {
            searchTerm = event.target.value || "";
            applyFilterAndSort();
          });
        }

        if (slotFilter) {
          enableToggleSelect(slotFilter);
          slotFilter.addEventListener("change", () => {
            selectedSlots = new Set(Array.from(slotFilter.selectedOptions).map((o) => o.value));
            applyFilterAndSort();
          });
        }

        if (resistFilter) {
          enableToggleSelect(resistFilter);
          resistFilter.addEventListener("change", () => {
            selectedResists = new Set(Array.from(resistFilter.selectedOptions).map((o) => o.value));
            applyFilterAndSort();
          });
        }

        if (closeBtn) {
          closeBtn.addEventListener("click", clearDetails);
        }

        init();
      })();
    </script>
  </body>
</html>
