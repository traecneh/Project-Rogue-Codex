<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Weapons - Project Rogue Codex</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <base href="../../" />
    <link rel="icon" type="image/x-icon" href="images/project-rogue-favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="images/project-rogue-favicon-32.png" />
    <link rel="icon" type="image/png" sizes="64x64" href="images/project-rogue-favicon-64.png" />
    <link rel="icon" type="image/png" sizes="180x180" href="images/project-rogue-favicon-180.png" />
    <link rel="icon" type="image/png" sizes="512x512" href="images/project-rogue-favicon-512.png" />
    <link rel="stylesheet" href="css/styles.css" />
    <script src="js/nav-loader.js" defer></script>
    <style>
      .item-controls {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        align-items: center;
        margin-bottom: 1rem;
      }

      .item-search {
        padding: 0.55rem 0.75rem;
        border: 1px solid var(--border-soft);
        border-radius: 6px;
        background: var(--bg-panel-dark);
        color: var(--text-main);
        width: min(420px, 100%);
      }

      .item-count {
        margin: 0;
        font-size: 0.9rem;
        color: var(--text-muted);
      }

      .item-filters {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        margin: 0 0 0.5rem;
      }

      .item-filter {
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
        min-width: 220px;
      }

      .filter-label {
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--text-muted);
        margin: 0;
      }

      .filter-select {
        background: var(--bg-panel-dark);
        color: var(--text-main);
        border: 1px solid var(--border-soft);
        border-radius: 6px;
        padding: 0.35rem 0.45rem;
        min-height: 120px;
        max-height: 180px;
        overflow: auto;
      }

      .filter-select:focus-visible {
        outline: 1px solid var(--accent);
      }

      .filter-select::-webkit-scrollbar {
        width: 10px;
        height: 10px;
      }

      .filter-select::-webkit-scrollbar-track {
        background: #0d1118;
        border-radius: 8px;
      }

      .filter-select::-webkit-scrollbar-thumb {
        background: linear-gradient(180deg, #3a414f, #262c36);
        border: 1px solid var(--border-soft);
        border-radius: 8px;
        box-shadow: inset 0 0 0 1px #0b0f16;
      }

      .filter-select::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(180deg, #4a5262, #2f3642);
      }

      .items-table-wrapper {
        overflow: visible;
        border: 1px solid var(--border-soft);
        border-radius: 8px;
        background: var(--bg-panel);
        box-shadow: 0 0 0 1px #0b0f16, 0 8px 16px rgba(0, 0, 0, 0.55);
      }

      .items-table {
        width: 100%;
        border-collapse: collapse;
        min-width: 640px;
        border: 1px solid var(--border-soft);
        box-shadow: 0 0 0 1px #0b0f16, 0 8px 16px rgba(0, 0, 0, 0.55);
      }

      .items-table thead {
        background: linear-gradient(to bottom, #303540, #252a33);
        position: sticky;
        top: 0;
        z-index: 3;
      }

      .items-table th,
      .items-table td {
        padding: 0.55rem 0.75rem;
        text-align: left;
        border-bottom: 1px solid #2f333b;
        font-size: 0.92rem;
      }

      .items-table th {
        background: linear-gradient(to bottom, #303540, #252a33);
        position: sticky;
        top: 0;
        z-index: 2;
        cursor: pointer;
        user-select: none;
        letter-spacing: 0.02em;
        color: #f9fafb;
        white-space: nowrap;
      }

      .items-table th .sort-indicator {
        margin-left: 0.35rem;
        font-size: 0.8rem;
        color: var(--text-muted);
      }

      .items-table tbody tr {
        background: var(--bg-panel-dark);
      }

      .items-table tbody tr:nth-child(2n) {
        background: #1d222b;
      }

      .items-table tbody tr:hover {
        background: rgba(75, 255, 75, 0.08);
        cursor: pointer;
      }

      .item-thumb {
        width: 32px;
        height: 32px;
        object-fit: cover;
        border-radius: 6px;
        border: 1px solid var(--border-soft);
        background: #0f1218;
        image-rendering: pixelated;
        image-rendering: crisp-edges;
      }

      .no-image {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 32px;
        min-height: 32px;
        padding: 0.2rem 0.35rem;
        border: 1px solid var(--border-soft);
        border-radius: 6px;
        background: #0f1218;
        color: var(--text-muted);
        font-size: 0.82rem;
        text-align: center;
      }

      .no-image-fallback {
        width: 32px;
        height: 32px;
        display: none;
        align-items: center;
        justify-content: center;
        border: 1px solid var(--border-soft);
        border-radius: 6px;
        background: #0f1218;
        color: var(--text-muted);
        font-size: 0.82rem;
        text-align: center;
      }

      .item-details {
        display: none;
        border: 1px solid var(--border-soft);
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        background: linear-gradient(135deg, #20252e, #141821);
        box-shadow: 0 0 0 1px #0b0f16, 0 12px 22px rgba(0, 0, 0, 0.65);
      }

      .item-details.show {
        display: block;
      }

      .item-details-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 1rem;
        margin-bottom: 0.6rem;
        flex-wrap: wrap;
      }

      .item-details-body {
        display: block;
      }

      .item-title-group {
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .item-details .item-thumb {
        width: 64px;
        height: 64px;
      }

      .item-details .no-image-fallback {
        width: 64px;
        height: 64px;
      }

      .details-button,
      .details-close {
        border: 1px solid var(--border-soft);
        background: linear-gradient(135deg, rgba(50, 60, 75, 0.9), rgba(20, 24, 32, 0.9));
        color: var(--text-main);
        padding: 0.45rem 0.9rem;
        border-radius: 6px;
        cursor: pointer;
        transition: background 0.15s ease, transform 0.1s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        font-weight: 600;
        letter-spacing: 0.02em;
        line-height: 1.2;
        min-height: 2.35rem;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.35);
      }

      .details-button:hover,
      .details-close:hover {
        background: linear-gradient(135deg, rgba(60, 72, 88, 0.95), rgba(26, 30, 40, 0.95));
        transform: translateY(-1px);
      }

      .table-empty {
        text-align: center;
        padding: 1rem;
        color: var(--text-muted);
      }

      .item-details::-webkit-scrollbar {
        width: 10px;
        height: 10px;
      }

      .item-details::-webkit-scrollbar-track {
        background: #0d1118;
        border-radius: 8px;
      }

      .item-details::-webkit-scrollbar-thumb {
        background: linear-gradient(180deg, #3a414f, #262c36);
        border: 1px solid var(--border-soft);
        border-radius: 8px;
        box-shadow: inset 0 0 0 1px #0b0f16;
      }

      .item-details-grid {
        display: grid;
        grid-template-columns: repeat(4, minmax(0, 1fr));
        gap: 0.5rem 1rem;
      }

      .detail-cell {
        padding: 0.3rem 0;
      }

      .detail-row {
        display: grid;
        gap: 0.5rem 0.75rem;
        margin-bottom: 0.35rem;
        grid-column: 1 / -1;
      }

      .detail-row-cols-1 {
        grid-template-columns: 1fr;
      }

      .detail-row-cols-2 {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }

      .detail-row-cols-3 {
        grid-template-columns: repeat(3, minmax(140px, 1fr));
      }

      .detail-row-cols-4 {
        grid-template-columns: repeat(4, minmax(0, 1fr));
      }

      .detail-label {
        font-size: 0.78rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--text-muted);
        margin: 0 0 0.1rem;
        display: block;
      }

      .detail-value {
        font-weight: 700;
        color: #fff;
      }

      .detail-divider {
        grid-column: 1 / -1;
        height: 1px;
        margin: 0.35rem 0 0.25rem;
        background: var(--border-soft);
        opacity: 0.6;
      }

      @media (max-width: 640px) {
        .item-details-grid {
          grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        }
      }
    </style>
  </head>
  <body>
    <div class="layout">
      <div id="sidebar-root"></div>
      <main class="main-content">
        <header class="content-header">
          <h1 class="content-title">Weapons</h1>
        </header>

        <section class="item-details" id="item-details" aria-live="polite">
          <div class="item-details-header">
            <div class="item-title-group">
              <div style="display: flex; align-items: center; gap: 0.5rem;">
                <img id="details-image" class="item-thumb" alt="" />
                <div id="details-image-fallback" class="no-image-fallback">No Image</div>
              </div>
              <h2 id="details-name" class="content-title" style="margin: 0"></h2>
            </div>
            <button type="button" class="details-button details-close" id="details-close">Close</button>
          </div>
          <div class="item-details-body">
            <div id="details-properties" class="item-details-grid"></div>
          </div>
        </section>

        <div class="content-section">
          <div class="item-controls">
            <input
              type="search"
              id="item-search"
              class="item-search"
              placeholder="Search weapons by any field..."
              aria-label="Search weapons"
            />
            <p class="item-count" id="item-count"></p>
          </div>

          <div class="item-filters" aria-label="Filters">
            <div class="item-filter">
              <label class="filter-label" for="filter-type">Type</label>
              <select id="filter-type" class="filter-select" multiple aria-label="Filter by type"></select>
            </div>
            <div class="item-filter">
              <label class="filter-label" for="filter-element">Element</label>
              <select id="filter-element" class="filter-select" multiple aria-label="Filter by element"></select>
            </div>
          </div>

          <div class="items-table-wrapper">
            <table class="items-table" aria-describedby="item-search">
              <thead>
                <tr id="items-head-row"></tr>
              </thead>
              <tbody id="items-body"></tbody>
            </table>
          </div>
        </div>
      </main>
    </div>


    <script>
      (() => {
        const PAGE = {
          title: "Weapons",
          dataFile: "weapons_data05.json",
        };

        const dataUrl = new URL(PAGE.dataFile, window.location.href);
        const searchInput = document.getElementById("item-search");
        const typeFilter = document.getElementById("filter-type");
        const elementFilter = document.getElementById("filter-element");
        const tableHeadRow = document.getElementById("items-head-row");
        const tableBody = document.getElementById("items-body");
        const countLabel = document.getElementById("item-count");
        const details = document.getElementById("item-details");
        const closeBtn = document.getElementById("details-close");

        const detailFields = {
          name: document.getElementById("details-name"),
          image: document.getElementById("details-image"),
          imageFallback: document.getElementById("details-image-fallback"),
          properties: document.getElementById("details-properties"),
        };

        const ELEMENT_COLORS = {
          fire: "#ff5a5a",
          electric: "#b86bff",
          poison: "#2f7a2f",
          cold: "#7cc9ff",
          acid: "#b38b00",
          disease: "#ff9c42",
        };

        const RESISTANCE_LABELS = {
          fire: "Fire Resistance",
          cold: "Cold Resistance",
          electric: "Electric Resistance",
          acid: "Acid Resistance",
          poison: "Poison Resistance",
          disease: "Disease Resistance",
        };

        const STAT_LABELS = {
          strength: "Strength",
          dexterity: "Dexterity",
          constitution: "Constitution",
        };

        const HIDDEN_NAMES = new Set(
          [
            "Super Super Blunt",
            "Super Duper Pole",
            "Super Duper",
            "Super Duper Blunt",
            "Super Duper Axe",
            "GM Deathbringer",
            "Ghostblade",
            "Wand of the Winds",
            "Wand of the Flames",
            "Tooth Staff",
            "Krythan Staff",
            "Bone Staff",
            "Staff of Might",
            "Cursed Staff",
            "Vengeance Sword",
          ].map((name) => name.toLowerCase())
        );

        const COLUMNS = [
          { key: "image", label: "Image", render: (_, item) => createImageThumb(item), sortable: false },
          { key: "name", label: "Name" },
          { key: "type", label: "Type" },
          { key: "level", label: "Level", format: (value) => formatNumber(value) },
          { key: "dps", label: "DPS", format: (value) => formatNumber(value, { maximumFractionDigits: 2 }) },
          { key: "perk", label: "Perk" },
          { key: "element", label: "Element", render: (value) => createElementBadge(value) },
        ];

        let items = [];
        let selectedTypes = new Set();
        let selectedElements = new Set();
        let sortKey = "dps";
        let sortDir = "desc";
        let searchTerm = "";
        const urlParams = new URLSearchParams(window.location.search);
        const normalizeWeaponId = (value) =>
          (value || "")
            .toString()
            .toLowerCase()
            .replace(/[^a-z0-9_-]+/g, "-")
            .replace(/^-+|-+$/g, "");
        const rawWeaponQuery = (urlParams.get("weapon") || urlParams.get("weaponName") || "").trim();
        const initialWeaponId = normalizeWeaponId(rawWeaponQuery);
        const initialWeaponSearchTerm = rawWeaponQuery.replace(/-/g, " ").trim();
        let pendingWeaponId = initialWeaponId;
        let pendingWeaponName = rawWeaponQuery.toLowerCase();

        const renderEmpty = (message) => {
          tableHeadRow.innerHTML = "";
          tableBody.innerHTML = `<tr><td class="table-empty" colspan="${COLUMNS.length || 1}">${message}</td></tr>`;
          if (countLabel) {
            countLabel.textContent = "0 results";
          }
        };

        const normalizeSortValue = (value) => {
          if (value === null || value === undefined) return "";
          if (typeof value === "number") return value;
          if (typeof value === "boolean") return value ? 1 : 0;
          if (Array.isArray(value)) return value.join(", ");
          if (typeof value === "object") return JSON.stringify(value);
          return String(value).toLowerCase();
        };

        const formatValue = (value) => {
          if (value === null || value === undefined || value === "") return "-";
          if (Array.isArray(value)) return value.join(", ");
          if (typeof value === "object") return JSON.stringify(value);
          return value;
        };

        const formatNumber = (value, options = {}) => {
          if (value === null || value === undefined || value === "") return "-";
          const num = Number(value);
          if (Number.isNaN(num)) return value;
          return num.toLocaleString("en-US", { maximumFractionDigits: 0, ...options });
        };

        const formatRange = (min, max) => {
          const hasMin = min !== null && min !== undefined && min !== "";
          const hasMax = max !== null && max !== undefined && max !== "";
          if (hasMin && hasMax) return `${formatNumber(min)} - ${formatNumber(max)}`;
          if (hasMin) return `${formatNumber(min)}`;
          if (hasMax) return `${formatNumber(max)}`;
          return "-";
        };

        const normalizeFilterValue = (value) => (value || "").toString().trim().toLowerCase();

        const setOptions = (select, options) => {
          if (!select) return;
          select.innerHTML = "";
          options.forEach(({ value, label }) => {
            const opt = document.createElement("option");
            opt.value = value;
            opt.textContent = label;
            select.appendChild(opt);
          });
        };

        const enableToggleSelect = (selectEl) => {
          if (!selectEl) return;
          selectEl.addEventListener("mousedown", (event) => {
            const option = event.target;
            if (option && option.tagName === "OPTION") {
              event.preventDefault();
              option.selected = !option.selected;
              selectEl.dispatchEvent(new Event("change", { bubbles: true }));
            }
          });
        };

        const deriveImageCandidates = (item, folder = "weapons") => {
          const candidates = [];
          const direct = typeof item === "string" ? item : item && item.image;
          if (direct) candidates.push(direct);
          const name = (item && (item.name || item.Name || item.id)) || "";
          const spaced = String(name).replace(/\s+/g, " ").trim();
          const safeName = spaced.replace(/[\\/:*?"<>|]/g, "");
          if (safeName) {
            const bases = [
              `images/${folder}`,
              `../images/${folder}`,
              `../../images/${folder}`,
              `/images/${folder}`,
            ];
            bases.forEach((base) => {
              const encoded = encodeURI(`${base}/${safeName}`);
              candidates.push(`${encoded}.gif`, `${encoded}.GIF`, `${encoded}.png`, `${encoded}.PNG`);
            });
          }
          return Array.from(new Set(candidates.filter(Boolean)));
        };

        const ensureImage = (img, fallback, item, folder = "weapons") => {
          if (!img || !fallback) return;
          fallback.style.display = "none";
          const sources = deriveImageCandidates(item, folder);
          if (!sources.length) {
            img.style.display = "none";
            fallback.style.display = "flex";
            return;
          }
          let index = 0;
          const trySet = () => {
            img.onload = () => {
              img.style.display = "block";
              fallback.style.display = "none";
            };
            img.onerror = () => {
              index += 1;
              if (index < sources.length) {
                trySet();
              } else {
                img.style.display = "none";
                fallback.style.display = "flex";
              }
            };
            img.src = sources[index];
          };
          trySet();
        };

        const createCell = (labelText, valueContent) => {
          const cell = document.createElement("div");
          cell.className = "detail-cell";
          const label = document.createElement("span");
          label.className = "detail-label";
          label.textContent = labelText;
          const value = document.createElement("div");
          value.className = "detail-value";
          if (valueContent instanceof Node) {
            value.appendChild(valueContent);
          } else {
            value.textContent = valueContent;
          }
          cell.appendChild(label);
          cell.appendChild(value);
          return cell;
        };

        const createPill = (items) => {
          const pill = document.createElement("span");
          pill.className = "flag-pill";
          pill.textContent = items.length ? items.join(", ") : "None";
          return pill;
        };

        const getElementColor = (value) => ELEMENT_COLORS[(value || "").toString().toLowerCase()] || "";

        const createElementBadge = (value) => {
          const span = document.createElement("span");
          span.textContent = formatValue(value);
          span.style.color = getElementColor(value);
          return span;
        };

        const createImageThumb = (item) => {
          const wrapper = document.createElement("div");
          wrapper.style.display = "inline-flex";
          wrapper.style.alignItems = "center";
          const img = document.createElement("img");
          img.className = "item-thumb";
          img.alt = `${item.name || "Item"} image`;
          const fallback = document.createElement("span");
          fallback.className = "no-image";
          fallback.textContent = "No Image";
          ensureImage(img, fallback, item);
          wrapper.appendChild(img);
          wrapper.appendChild(fallback);
          return wrapper;
        };

        const populateFilters = (data) => {
          const typeOptions = new Map();
          const elementOptions = new Set();

          data.forEach((w) => {
            const typeValue = normalizeFilterValue(w.type);
            if (typeValue) {
              if (!typeOptions.has(typeValue)) {
                typeOptions.set(typeValue, String(w.type));
              }
            }
            const elementValue = normalizeFilterValue(w.element);
            if (elementValue && elementValue !== "none") {
              elementOptions.add(String(w.element));
            }
          });

          const typeList = Array.from(typeOptions.entries())
            .sort((a, b) => a[1].localeCompare(b[1]))
            .map(([value, label]) => ({ value, label }));
          const elementList = Array.from(elementOptions)
            .sort((a, b) => a.localeCompare(b))
            .map((value) => ({ value: normalizeFilterValue(value), label: value }));

          setOptions(typeFilter, typeList);
          setOptions(elementFilter, elementList);
        };

        const computeDps = (minDamage, maxDamage, attackSpeed) => {
          const min = Number(minDamage);
          const max = Number(maxDamage);
          const speed = Number(attackSpeed);
          if (Number.isNaN(min) || Number.isNaN(max) || Number.isNaN(speed) || speed === 0) return null;
          const avgDamage = (min + max) / 2;
          return Number((avgDamage * (1000 / speed)).toFixed(2));
        };

        const buildRarity = (fields) => {
          const max = fields.max_rarity_label || fields.max_rarity;
          const maxLabel = max === null || max === undefined || max === "" ? "-" : max;
          return `Regular - ${maxLabel}`;
        };

        const normalizeWeapon = (raw) => {
          const fields = (raw && typeof raw.fields === "object" && raw.fields) || {};
          const value = fields.value;
          const sellValue =
            value === null || value === undefined || value === ""
              ? null
              : Number.isNaN(Number(value))
                ? null
                : Number(value) / 2;

          return {
            id: raw && (raw.id ?? raw.ID) ? raw.id ?? raw.ID : normalizeWeaponId(raw && (raw.name || raw.Name)),
            name: (raw && (raw.name || raw.Name)) || "Unknown",
            image: raw && (raw.image || raw.icon || raw.thumbnail) ? raw.image || raw.icon || raw.thumbnail : "",
            level: fields.level_requirement,
            minDamage: fields.min_damage,
            maxDamage: fields.max_damage,
            attackSpeed: fields.attack_speed,
            dps: computeDps(fields.min_damage, fields.max_damage, fields.attack_speed),
            type: fields.subtype_label || fields.subtype,
            perk: fields.perk ? fields.perk_label || fields.perk : "None",
            element: fields.element_label || (fields.element ? fields.element : "None"),
            procChance: fields.proc_chance,
            skillRequirement: fields.skill_requirement,
            weight: fields.weight,
            specialty: fields.specialty ? fields.specialty_label || fields.specialty : "None",
            specialtyAmount: fields.specialty_amount,
            rarity: buildRarity(fields),
            maxRarityLabel: fields.max_rarity_label || fields.max_rarity,
            toHit: fields.to_hit,
            value,
            sellValue,
            shardDecompositionAmount: fields.shard_decomposition_amount,
            shardPromotionAmount: fields.shard_promotion_amount,
            resistances: {
              fire: fields.fire_resistance,
              cold: fields.cold_resistance,
              electric: fields.electric_resistance,
              acid: fields.acid_resistance,
              poison: fields.poison_resistance,
              disease: fields.disease_resistance,
            },
            stats: {
              strength: fields.strength,
              dexterity: fields.dexterity,
              constitution: fields.constitution,
            },
          };
        };

        const getWeaponId = (item) => normalizeWeaponId(item && (item.id || item.name));

        const maybeSelectPendingWeapon = (list) => {
          if (!pendingWeaponId && !pendingWeaponName) return;
          const match = (list || items).find((w) => {
            const id = getWeaponId(w);
            const nameLower = (w.name || "").toLowerCase();
            return (pendingWeaponId && id === pendingWeaponId) || (pendingWeaponName && nameLower === pendingWeaponName);
          });
          if (!match) return;
          pendingWeaponId = "";
          pendingWeaponName = "";
          setDetails(match);
        };

        const updateSortIndicators = () => {
          document.querySelectorAll(".items-table th[data-sort-key]").forEach((th) => {
            const key = th.getAttribute("data-sort-key");
            const indicator = th.querySelector(".sort-indicator");
            const isActive = key === sortKey;
            const ariaSort = isActive ? (sortDir === "asc" ? "ascending" : "descending") : "none";
            th.setAttribute("aria-sort", ariaSort);
            if (indicator) {
              indicator.textContent = isActive ? (sortDir === "asc" ? "\u25B2" : "\u25BC") : "\u2195";
            }
          });
        };

        const buildHead = () => {
          tableHeadRow.innerHTML = "";
          COLUMNS.forEach((col) => {
            const th = document.createElement("th");
            th.setAttribute("scope", "col");

            const labelSpan = document.createElement("span");
            labelSpan.textContent = col.label;
            th.appendChild(labelSpan);

            if (col.sortable !== false) {
              th.dataset.sortKey = col.key;
              const indicator = document.createElement("span");
              indicator.className = "sort-indicator";
              indicator.setAttribute("aria-hidden", "true");
              indicator.textContent = "\u2195";
              th.appendChild(indicator);

              th.addEventListener("click", () => {
                if (sortKey === col.key) {
                  sortDir = sortDir === "asc" ? "desc" : "asc";
                } else {
                  sortKey = col.key;
                  sortDir = "asc";
                }
                applyFilterAndSort();
              });
            } else {
              th.style.cursor = "default";
            }

            tableHeadRow.appendChild(th);
          });
          updateSortIndicators();
        };

        const setDetails = (item) => {
          if (!item) return;
          detailFields.name.textContent = item.name || "Unknown";
          ensureImage(detailFields.image, detailFields.imageFallback, item);

          const container = detailFields.properties;
          container.innerHTML = "";

          const addDivider = () =>
            container.appendChild(Object.assign(document.createElement("div"), { className: "detail-divider" }));
          const addRow = (entries, cols) => {
            const row = document.createElement("div");
            row.className = `detail-row detail-row-cols-${cols || 2}`;
            entries.forEach(([label, value]) => row.appendChild(createCell(label, value)));
            container.appendChild(row);
          };

          addRow(
            [
              ["Type", formatValue(item.type)],
              ["DPS", formatNumber(item.dps, { maximumFractionDigits: 2 })],
              ["Damage", formatRange(item.minDamage, item.maxDamage)],
              [
                "Speed",
                item.attackSpeed === null || item.attackSpeed === undefined
                  ? "-"
                  : `${formatNumber(item.attackSpeed)} ms`,
              ],
            ],
            4
          );
          addRow(
            [
              ["Element", createElementBadge(item.element)],
              ["To Hit", formatNumber(item.toHit)],
              ["Level", formatNumber(item.level)],
              [
                "Proc",
                item.procChance === null || item.procChance === undefined || item.procChance === ""
                  ? "-"
                  : `${formatNumber(item.procChance, { maximumFractionDigits: 2 })}%`,
              ],
            ],
            4
          );
          addRow(
            [
              ["Specialty", formatValue(item.specialty)],
              ["Specialty Amount", formatNumber(item.specialtyAmount)],
              ["Weight", formatNumber(item.weight)],
              ["Rarity", formatValue(item.rarity)],
            ],
            4
          );

          addDivider();

          addRow(
            [
              ["Strength", formatNumber((item.stats && item.stats.strength) ?? 0)],
              ["Constitution", formatNumber((item.stats && item.stats.constitution) ?? 0)],
              ["Dexterity", formatNumber((item.stats && item.stats.dexterity) ?? 0)],
              ["", ""],
            ],
            4
          );

          addDivider();

          const res = item.resistances || {};
          addRow(
            [
              ["Fire", formatNumber(res.fire ?? 0)],
              ["Poison", formatNumber(res.poison ?? 0)],
              ["Cold", formatNumber(res.cold ?? 0)],
            ],
            3
          );
          addRow(
            [
              ["Disease", formatNumber(res.disease ?? 0)],
              ["Acid", formatNumber(res.acid ?? 0)],
              ["Electric", formatNumber(res.electric ?? 0)],
            ],
            3
          );

          addDivider();

          addRow([["Innate Perk", formatValue(item.perk)]], 1);

          addDivider();

          addRow(
            [
              ["Max Rarity", formatValue(item.maxRarityLabel || item.rarity)],
              ["Promotion", formatNumber(item.shardPromotionAmount)],
              ["Deconstruction", formatNumber(item.shardDecompositionAmount)],
            ],
            3
          );

          addDivider();

          addRow([["Requirement", `Skill Level ${formatNumber(item.skillRequirement)}`]], 1);

          addDivider();

          addRow(
            [
              ["Value", formatNumber(item.value)],
              ["Sell Value", formatNumber(item.sellValue, { maximumFractionDigits: 2 })],
            ],
            2
          );

          details.classList.add("show");
          details.scrollIntoView({ behavior: "smooth", block: "start" });
        };

        const clearDetails = () => {
          details.classList.remove("show");
        };

        const renderTable = (rows) => {
          if (!rows.length) {
            renderEmpty("No weapons match your filters.");
            return;
          }

          const fragment = document.createDocumentFragment();

          rows.forEach((item) => {
            const tr = document.createElement("tr");
            tr.dataset.id = item.id || "";

            COLUMNS.forEach((col) => {
              const td = document.createElement("td");
              const value = item[col.key];
              if (col.render) {
                const rendered = col.render(value, item);
                if (rendered instanceof Node) {
                  td.appendChild(rendered);
                } else {
                  td.textContent = formatValue(rendered);
                }
              } else if (col.format) {
                td.textContent = col.format(value);
              } else {
                td.textContent = formatValue(value);
              }
              tr.appendChild(td);
            });

            tr.addEventListener("click", () => setDetails(item));
            fragment.appendChild(tr);
          });

          tableBody.innerHTML = "";
          tableBody.appendChild(fragment);
        };

        const applyFilterAndSort = () => {
          if (!Array.isArray(items) || !items.length) {
            renderEmpty("No weapons found in weapons_data05.json.");
            return;
          }

          const searchableColumns = COLUMNS.map((c) => c.key);

          const filtered = items.filter((item) => {
            const matchesType = selectedTypes.size === 0 || selectedTypes.has(normalizeFilterValue(item.type));
            const matchesElement =
              selectedElements.size === 0 || selectedElements.has(normalizeFilterValue(item.element));
            if (!matchesType || !matchesElement) return false;
            if (!searchTerm) return true;
            const text = searchableColumns
              .map((col) => formatValue(item[col]))
              .join(" ")
              .toLowerCase();
            return text.includes(searchTerm.toLowerCase());
          });

          const sorted = filtered.sort((a, b) => {
            const av = normalizeSortValue(a[sortKey]);
            const bv = normalizeSortValue(b[sortKey]);
            if (av < bv) return sortDir === "asc" ? -1 : 1;
            if (av > bv) return sortDir === "asc" ? 1 : -1;
            return 0;
          });

          updateSortIndicators();

          if (countLabel) {
            const count = sorted.length;
            countLabel.textContent = `${count} result${count === 1 ? "" : "s"}`;
          }

          renderTable(sorted);
          maybeSelectPendingWeapon(sorted);
        };

        const init = () => {
          fetch(dataUrl.toString())
            .then((response) => {
              if (!response.ok) {
                throw new Error("Failed to load weapons_data05.json");
              }
              return response.json();
            })
            .then((data) => {
              items = (Array.isArray(data) ? data : [])
                .map((row) => normalizeWeapon(row))
                .filter((weapon) => {
                  const nameLower = (weapon.name || "").toLowerCase();
                  const levelNum = Number(weapon.level);
                  if (nameLower === "flaming sword" && levelNum === 0) return false;
                  return !HIDDEN_NAMES.has(nameLower);
                });
              if (!items.length) {
                renderEmpty("Add weapons_data05.json beside this page to see weapons.");
                return;
              }
              sortKey = "dps";
              sortDir = "desc";
              selectedTypes = new Set();
              selectedElements = new Set();
              buildHead();
              populateFilters(items);
              if (initialWeaponSearchTerm) {
                searchTerm = initialWeaponSearchTerm;
                if (searchInput) searchInput.value = initialWeaponSearchTerm;
              }
              applyFilterAndSort();
            })
            .catch(() => {
              renderEmpty("Unable to load weapons. Add weapons_data05.json beside this page.");
            });
        };

        if (searchInput) {
          searchInput.addEventListener("input", (event) => {
            searchTerm = event.target.value || "";
            applyFilterAndSort();
          });
        }

        if (typeFilter) {
          enableToggleSelect(typeFilter);
          typeFilter.addEventListener("change", () => {
            selectedTypes = new Set(Array.from(typeFilter.selectedOptions).map((o) => o.value));
            applyFilterAndSort();
          });
        }

        if (elementFilter) {
          enableToggleSelect(elementFilter);
          elementFilter.addEventListener("change", () => {
            selectedElements = new Set(Array.from(elementFilter.selectedOptions).map((o) => o.value));
            applyFilterAndSort();
          });
        }

        if (closeBtn) {
          closeBtn.addEventListener("click", clearDetails);
        }

        init();
      })();
    </script>

  </body>
</html>
